var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf3=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _react=_interopRequireWildcard(require("react"));var _classnames3=_interopRequireDefault(require("classnames"));var _events=_interopRequireDefault(require("../utils/events"));var _drag=_interopRequireDefault(require("../drag"));var _tooltip=_interopRequireDefault(require("../tooltip"));var _jsxFileName="/Users/linji/Documents/workspace/zarm/zarm/components/slider/index.tsx";var getValue=function getValue(props,defaultValue){if(typeof props.value!=='undefined'){return props.value;}if(typeof props.defaultValue!=='undefined'){return props.defaultValue||defaultValue;}return defaultValue;};function preventDefault(event){event.preventDefault();}function getPrecision(step){var stepString=step.toString();var precision=0;if(stepString.indexOf('.')>=0){precision=stepString.length-stepString.indexOf('.')-1;}return precision;}function getClosestPoint(val,_ref){var marks=_ref.marks,step=_ref.step,min=_ref.min,max=_ref.max;var points=Object.keys(marks||{}).map(parseFloat);if(step!==null){var maxSteps=Math.floor((max-min)/step);var steps=Math.min((val-min)/step,maxSteps);var closestStep=Math.round(steps)*step+min;points.push(closestStep);}var diffs=points.map(function(point){return Math.abs(val-point);});return points[diffs.indexOf(Math.min.apply(Math,(0,_toConsumableArray2.default)(diffs)))];}function ensureValuePrecision(val,props){var step=props.step;var closestPoint=Number.isFinite(getClosestPoint(val,props))?getClosestPoint(val,props):0;return step===null?closestPoint:parseFloat(closestPoint.toFixed(getPrecision(step)));}var Slider=function(_PureComponent){(0,_inherits2.default)(Slider,_PureComponent);function Slider(){var _getPrototypeOf2;var _this;(0,_classCallCheck2.default)(this,Slider);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=(0,_possibleConstructorReturn2.default)(this,(_getPrototypeOf2=(0,_getPrototypeOf3.default)(Slider)).call.apply(_getPrototypeOf2,[this].concat(args)));_this.line=null;_this.container=null;_this.offsetStart=0;_this.state={value:getValue(_this.props,0),prevPropsValue:getValue(_this.props,0),tooltip:false};_this.init=function(){var value=_this.state.value;_this.offsetStart=_this.getOffsetByValue(value);};_this.getValueByOffset=function(offset){var _this$props=_this.props,_this$props$min=_this$props.min,min=_this$props$min===void 0?0:_this$props$min,max=_this$props.max,vertical=_this$props.vertical;var percent=offset/_this.getMaxOffset();var value=vertical?(1-percent)*(max-min)+min:Math.round(min+(max-min)*percent);return ensureValuePrecision(value,_this.props);};_this.getOffsetPercent=function(value){var _this$props2=_this.props,min=_this$props2.min,max=_this$props2.max;var ratio=(value-min)/(max-min);return ratio*100+"%";};_this.getOffsetByValue=function(value){var _this$props3=_this.props,vertical=_this$props3.vertical,min=_this$props3.min,max=_this$props3.max;var maxOffset=_this.getMaxOffset();var range=max-min;return vertical?maxOffset*((max-value)/range):maxOffset*((value-min)/range);};_this.getMaxOffset=function(){if(_this.line){if(_this.props.vertical){return _this.line.offsetHeight;}return _this.line.offsetWidth;}return 0;};_this.handleDragStart=function(){var disabled=_this.props.disabled;if(disabled){return;}_this.setState({tooltip:true});};_this.handleDragMove=function(event,dragState){var _this$props4=_this.props,disabled=_this$props4.disabled,vertical=_this$props4.vertical;if(disabled){return false;}_tooltip.default.updateAll();event.stopPropagation();event.preventDefault();var _ref2=dragState,offsetX=_ref2.offsetX,offsetY=_ref2.offsetY;var offset=vertical?_this.offsetStart+(offsetY||0):(_this.offsetStart||0)+(offsetX||0);if(offset<0){offset=0;var newValue=_this.getValueByOffset(offset);_this.setState({value:newValue});return false;}var maxOffset=_this.getMaxOffset();if(offset>maxOffset){offset=maxOffset;var _newValue=_this.getValueByOffset(offset);_this.setState({value:_newValue});return false;}var value=_this.getValueByOffset(offset);_this.setState({value:value});return true;};_this.handleDragEnd=function(_event,dragState){var _this$props5=_this.props,vertical=_this$props5.vertical,onChange=_this$props5.onChange;var _ref3=dragState,offsetX=_ref3.offsetX,offsetY=_ref3.offsetY;_this.setState({tooltip:false});if(vertical){if(Number.isNaN(offsetY)){return;}}else if(Number.isNaN(offsetX)){return;}_this.offsetStart+=vertical?offsetY:offsetX;if(typeof onChange==='function'){onChange(_this.state.value);}};_this.handleRef=function(ref){var nextContainer=ref;var prevContainer=_this.container;if(prevContainer!==nextContainer){if(prevContainer){prevContainer.removeEventListener('touchstart',preventDefault);}if(nextContainer){nextContainer.addEventListener('touchstart',preventDefault,{passive:false});}}_this.container=nextContainer;};_this.renderMarkInfo=function(){var _this$props6=_this.props,prefixCls=_this$props6.prefixCls,showMark=_this$props6.showMark,_this$props6$marks=_this$props6.marks,marks=_this$props6$marks===void 0?{}:_this$props6$marks,vertical=_this$props6.vertical;var value=_this.state.value;var isEmptyMarks=typeof marks!=='object'||JSON.stringify(marks)==='{}';if(showMark&&isEmptyMarks){console.error('请输入有效的 marks');return null;}if(isEmptyMarks){return null;}var markKeys=Object.keys(marks||{});var markElement=markKeys.map(function(item){var markStyle=(0,_defineProperty2.default)({},vertical?'bottom':'left',item+"%");return _react.default.createElement("span",{key:item,className:prefixCls+"__mark",style:markStyle,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:306}},marks[+item]);});var marksElement=showMark&&_react.default.createElement("div",{className:prefixCls+"__marks",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:317}},markElement);var lineDot=markKeys.map(function(item){var dotStyle=(0,_classnames3.default)(prefixCls+"__line__dot",(0,_defineProperty2.default)({},prefixCls+"__line__dot--active",value>=+item));var markStyle=(0,_defineProperty2.default)({},vertical?'bottom':'left',item+"%");return _react.default.createElement("span",{key:item,className:dotStyle,style:markStyle,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:332}});});return _react.default.createElement(_react.default.Fragment,null,lineDot,marksElement);};return _this;}(0,_createClass2.default)(Slider,[{key:"componentDidMount",value:function componentDidMount(){this.init();_events.default.on(window,'resize',this.init);}},{key:"render",value:function render(){var _classnames2,_this2=this;var _this$props7=this.props,prefixCls=_this$props7.prefixCls,className=_this$props7.className,disabled=_this$props7.disabled,min=_this$props7.min,max=_this$props7.max,vertical=_this$props7.vertical,showMark=_this$props7.showMark;var _this$state=this.state,value=_this$state.value,tooltip=_this$state.tooltip;var offset=this.getOffsetPercent(value);var cls=(0,_classnames3.default)(prefixCls,className,(_classnames2={},(0,_defineProperty2.default)(_classnames2,prefixCls+"--disabled",disabled),(0,_defineProperty2.default)(_classnames2,prefixCls+"--vertical",vertical),(0,_defineProperty2.default)(_classnames2,prefixCls+"--marked",showMark),_classnames2));var handleStyle=(0,_defineProperty2.default)({},vertical?'bottom':'left',offset||0);var lineBg=(0,_defineProperty2.default)({},vertical?'height':'width',offset||0);return _react.default.createElement("div",{className:cls,ref:this.handleRef,__self:this,__source:{fileName:_jsxFileName,lineNumber:377}},_react.default.createElement("div",{className:prefixCls+"__content",__self:this,__source:{fileName:_jsxFileName,lineNumber:378}},_react.default.createElement("div",{className:prefixCls+"__line",ref:function ref(ele){_this2.line=ele;},__self:this,__source:{fileName:_jsxFileName,lineNumber:379}},_react.default.createElement("div",{className:prefixCls+"__line__bg",style:lineBg,__self:this,__source:{fileName:_jsxFileName,lineNumber:380}}),this.renderMarkInfo()),_react.default.createElement(_drag.default,{onDragStart:this.handleDragStart,onDragMove:this.handleDragMove,onDragEnd:this.handleDragEnd,__self:this,__source:{fileName:_jsxFileName,lineNumber:388}},_react.default.createElement("div",{className:prefixCls+"__handle",role:"slider","aria-valuemin":min,"aria-valuemax":max,"aria-valuenow":value,"aria-orientation":vertical?'vertical':'horizontal',style:handleStyle,__self:this,__source:{fileName:_jsxFileName,lineNumber:393}},_react.default.createElement(_tooltip.default,{trigger:"manual",arrowPointAtCenter:true,visible:tooltip,content:value,__self:this,__source:{fileName:_jsxFileName,lineNumber:402}},_react.default.createElement("div",{className:prefixCls+"__handle__shadow",__self:this,__source:{fileName:_jsxFileName,lineNumber:403}}))))));}}],[{key:"getDerivedStateFromProps",value:function getDerivedStateFromProps(nextProps,prevState){var value=nextProps.value;if(typeof value!=='undefined'&&value!==prevState.prevPropsValue){return(0,_extends2.default)({},prevState,{value:value,prevPropsValue:value});}return null;}}]);return Slider;}(_react.PureComponent);exports.default=Slider;Slider.defaultProps={prefixCls:'za-slider',disabled:false,showMark:false,vertical:false,step:1,min:0,max:100,marks:{}};