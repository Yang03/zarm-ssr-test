var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _react=_interopRequireWildcard(require("react"));var _classnames2=_interopRequireDefault(require("classnames"));var _PropsType=require("./PropsType");var _events=_interopRequireDefault(require("../utils/events"));var _throttle=_interopRequireDefault(require("../utils/throttle"));var _dom=require("../utils/dom");var _drag=_interopRequireDefault(require("../drag"));var _activityIndicator=_interopRequireDefault(require("../activity-indicator"));var _icon=_interopRequireDefault(require("../icon"));var _jsxFileName="/Users/linji/Documents/workspace/zarm/zarm/components/pull/Pull.tsx";var Pull=function(_PureComponent){(0,_inherits2.default)(Pull,_PureComponent);function Pull(props){var _this;(0,_classCallCheck2.default)(this,Pull);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(Pull).call(this,props));_this.mounted=true;_this.getScrollContainer=function(){if(process.env.NODE_ENV!=='production'){console.warn("Warning: getScrollContainer() has been renamed, and is not recommended for use.\n\n* Rename `getScrollContainer()` to `scrollContainer` to suppress this warning.");}return _this.scrollContainer;};_this.wrapTouchstart=function(event){var touch=event.touches[0];_this.wrapTouchstartY=touch.pageY;};_this.wrapTouchmove=function(event){var touch=event.touches[0];var currentY=touch.pageY;if(currentY-_this.wrapTouchstartY>0&&event.cancelable&&_this.scrollTop===0){event.preventDefault();}};_this.wrapTouchEnd=function(){_this.wrapTouchstartY=0;_this.setState({animationDuration:_this.props.animationDuration});};_this.addScrollEvent=function(){_this.wrap=_this.scrollContainer;var scroller=_this.wrap===document.documentElement?window:_this.wrap;_events.default.on(scroller,'scroll',_this.throttledScroll);};_this.onScroll=function(){var _this$state=_this.state,refreshState=_this$state.refreshState,loadState=_this$state.loadState;var _this$wrap=_this.wrap,scrollHeight=_this$wrap.scrollHeight,clientHeight=_this$wrap.clientHeight;var load=(0,_extends2.default)({},Pull.defaultProps.load,_this.props.load);var handler=load.handler,distance=load.distance;if(typeof handler!=='function'||refreshState!==_PropsType.REFRESH_STATE.normal||loadState!==_PropsType.LOAD_STATE.normal||scrollHeight<=clientHeight||scrollHeight-_this.scrollTop-distance>clientHeight){return;}handler();};_this.onDragMove=function(event,_ref){var offsetY=_ref.offsetY;var _ref2=_this.props.refresh,handler=_ref2.handler;if(!handler||offsetY<=0||offsetY>0&&_this.scrollTop>0||_this.state.refreshState>=_PropsType.REFRESH_STATE.loading){return false;}event.preventDefault();var refresh=(0,_extends2.default)({},Pull.defaultProps.refresh,_this.props.refresh);var startDistance=refresh.startDistance,distance=refresh.distance;var offset=offsetY/3;var action=offset-startDistance<distance?_PropsType.REFRESH_STATE.pull:_PropsType.REFRESH_STATE.drop;_this.doRefreshAction(action,offset);return true;};_this.onDragEnd=function(_event,_ref3){var offsetY=_ref3.offsetY;if(!offsetY){return;}var refreshState=_this.state.refreshState;if(refreshState===_PropsType.REFRESH_STATE.pull){_this.doRefreshAction(_PropsType.REFRESH_STATE.normal);return;}var _ref4=_this.props.refresh,handler=_ref4.handler;if(typeof handler==='function'){handler();}};_this.doTransition=function(_ref5){var offsetY=_ref5.offsetY,animationDuration=_ref5.animationDuration;_this.setState({offsetY:offsetY,animationDuration:animationDuration});};_this.doRefreshAction=function(refreshState,offsetY){var _this$props=_this.props,animationDuration=_this$props.animationDuration,stayTime=_this$props.stayTime;_this.setState({refreshState:refreshState});switch(refreshState){case _PropsType.REFRESH_STATE.pull:case _PropsType.REFRESH_STATE.drop:_this.doTransition({offsetY:offsetY,animationDuration:0});break;case _PropsType.REFRESH_STATE.loading:_this.doTransition({offsetY:'auto',animationDuration:animationDuration});break;case _PropsType.REFRESH_STATE.success:case _PropsType.REFRESH_STATE.failure:_this.doTransition({offsetY:'auto',animationDuration:animationDuration});setTimeout(function(){if(!_this.mounted)return;_this.doRefreshAction(_PropsType.REFRESH_STATE.normal);_this.doLoadAction(_PropsType.LOAD_STATE.normal);},stayTime);break;default:_this.doTransition({offsetY:0,animationDuration:animationDuration});}};_this.doLoadAction=function(loadState){var stayTime=_this.props.stayTime;_this.setState({loadState:loadState});switch(loadState){case _PropsType.LOAD_STATE.success:_this.doLoadAction(_PropsType.LOAD_STATE.normal);break;case _PropsType.LOAD_STATE.failure:setTimeout(function(){if(!_this.mounted)return;_this.doLoadAction(_PropsType.LOAD_STATE.abort);},stayTime);break;default:}};_this.renderRefresh=function(){var refresh=(0,_extends2.default)({},Pull.defaultProps.refresh,_this.props.refresh);var startDistance=refresh.startDistance,distance=refresh.distance,render=refresh.render;var _this$state2=_this.state,refreshState=_this$state2.refreshState,offsetY=_this$state2.offsetY;var percent=0;if(offsetY>=startDistance){percent=(offsetY-startDistance<distance?offsetY-startDistance:distance)*100/distance;}if(typeof render==='function'){return render(refreshState,percent);}var _this$props2=_this.props,prefixCls=_this$props2.prefixCls,locale=_this$props2.locale;var cls=prefixCls+"__control";switch(refreshState){case _PropsType.REFRESH_STATE.pull:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:331}},_react.default.createElement(_activityIndicator.default,{loading:false,percent:percent,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:332}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:333}},locale.pullText));case _PropsType.REFRESH_STATE.drop:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:339}},_react.default.createElement(_activityIndicator.default,{loading:false,percent:100,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:340}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:341}},locale.dropText));case _PropsType.REFRESH_STATE.loading:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:347}},_react.default.createElement(_activityIndicator.default,{type:"spinner",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:348}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:349}},locale.loadingText));case _PropsType.REFRESH_STATE.success:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:355}},_react.default.createElement(_icon.default,{type:"right-round",theme:"success",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:356}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:357}},locale.successText));case _PropsType.REFRESH_STATE.failure:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:363}},_react.default.createElement(_icon.default,{type:"wrong-round",theme:"danger",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:364}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:365}},locale.failureText));default:}};_this.renderLoad=function(){var load=(0,_extends2.default)({},Pull.defaultProps.load,_this.props.load);var render=load.render;var loadState=_this.state.loadState;if(typeof render==='function'){return render(loadState);}var _this$props3=_this.props,prefixCls=_this$props3.prefixCls,locale=_this$props3.locale;var cls=prefixCls+"__control";switch(loadState){case _PropsType.LOAD_STATE.loading:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:391}},_react.default.createElement(_activityIndicator.default,{type:"spinner",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:392}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:393}},locale.loadingText));case _PropsType.LOAD_STATE.failure:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:399}},_react.default.createElement(_icon.default,{type:"wrong-round",theme:"danger",__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:400}}),_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:401}},locale.failureText));case _PropsType.LOAD_STATE.complete:return _react.default.createElement("div",{className:cls,__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:407}},_react.default.createElement("span",{__self:(0,_assertThisInitialized2.default)(_this),__source:{fileName:_jsxFileName,lineNumber:408}},locale.completeText));default:}};_this.state={offsetY:0,animationDuration:0,refreshState:props.refresh.state,loadState:props.load.state};_this.throttledScroll=(0,_throttle.default)(_this.onScroll,250);return _this;}(0,_createClass2.default)(Pull,[{key:"componentDidMount",value:function componentDidMount(){this.mounted=true;this.addScrollEvent();_events.default.on(this.wrap,'touchstart',this.wrapTouchstart);_events.default.on(this.wrap,'touchmove',this.wrapTouchmove);_events.default.on(this.wrap,'touchend',this.wrapTouchEnd);}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){if(this.wrap!==this.scrollContainer){this.addScrollEvent();}var _this$props4=this.props,load=_this$props4.load,refresh=_this$props4.refresh;if(prevProps.load.state!==load.state){this.doLoadAction(load.state);}if(prevProps.refresh.state!==refresh.state){this.doRefreshAction(refresh.state);}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.mounted=false;var scroller=this.wrap===document.documentElement?window:this.wrap;_events.default.off(scroller,'scroll',this.throttledScroll);_events.default.off(this.wrap,'touchstart',this.wrapTouchstart);_events.default.off(this.wrap,'touchmove',this.wrapTouchmove);_events.default.off(this.wrap,'touchend',this.wrapTouchEnd);}},{key:"render",value:function render(){var _this2=this;var _this$props5=this.props,prefixCls=_this$props5.prefixCls,className=_this$props5.className,style=_this$props5.style,children=_this$props5.children;var _this$state3=this.state,offsetY=_this$state3.offsetY,animationDuration=_this$state3.animationDuration,refreshState=_this$state3.refreshState,loadState=_this$state3.loadState;var cls=(0,_classnames2.default)(prefixCls,className);var loadCls=(0,_classnames2.default)(prefixCls+"__load",(0,_defineProperty2.default)({},prefixCls+"__load--show",loadState>=_PropsType.LOAD_STATE.loading));var contentStyle={WebkitTransition:"all "+animationDuration+"ms",transition:"all "+animationDuration+"ms"};if(refreshState<=_PropsType.REFRESH_STATE.drop){contentStyle.WebkitTransform="translate3d(0, "+offsetY+"px, 0)";contentStyle.transform="translate3d(0, "+offsetY+"px, 0)";}return _react.default.createElement(_drag.default,{onDragMove:this.onDragMove,onDragEnd:this.onDragEnd,__self:this,__source:{fileName:_jsxFileName,lineNumber:436}},_react.default.createElement("div",{className:cls,style:style,__self:this,__source:{fileName:_jsxFileName,lineNumber:440}},_react.default.createElement("div",{className:prefixCls+"__content",style:contentStyle,ref:function ref(ele){_this2.pull=ele;},__self:this,__source:{fileName:_jsxFileName,lineNumber:441}},_react.default.createElement("div",{className:prefixCls+"__refresh",__self:this,__source:{fileName:_jsxFileName,lineNumber:442}},this.renderRefresh()),_react.default.createElement("div",{className:prefixCls+"__body",__self:this,__source:{fileName:_jsxFileName,lineNumber:445}},children),_react.default.createElement("div",{className:loadCls,__self:this,__source:{fileName:_jsxFileName,lineNumber:446}},this.renderLoad()))));}},{key:"scrollContainer",get:function get(){var container=function(node){while(node&&node.parentNode&&node.parentNode!==document.body){var style=window.getComputedStyle(node);if((['scroll','auto'].indexOf(style.overflowY)>-1||['scroll','auto'].indexOf(style.overflow)>-1)&&(parseInt(style.height,10)>0||parseInt(style.maxHeight,10)>0)){return node;}node=node.parentNode;}}(this.pull)||document.documentElement;return container;}},{key:"scrollTop",get:function get(){return(0,_dom.getScrollTop)(this.wrap);}}],[{key:"getDerivedStateFromProps",value:function getDerivedStateFromProps(nextProps,state){var load=nextProps.load,refresh=nextProps.refresh;var _state$prevLoad=state.prevLoad,prevLoad=_state$prevLoad===void 0?{}:_state$prevLoad,_state$prevRefresh=state.prevRefresh,prevRefresh=_state$prevRefresh===void 0?{}:_state$prevRefresh;if('load'in nextProps&&load.state!==prevLoad.state){return{loadState:load.state,prevLoad:load};}if('refresh'in nextProps&&refresh.state!==prevRefresh.state){return{refreshState:refresh.state,prevRefresh:refresh};}return null;}}]);return Pull;}(_react.PureComponent);exports.default=Pull;Pull.defaultProps={prefixCls:'za-pull',refresh:{state:_PropsType.REFRESH_STATE.normal,startDistance:30,distance:30},load:{state:_PropsType.LOAD_STATE.normal,distance:0},animationDuration:400,stayTime:1000};